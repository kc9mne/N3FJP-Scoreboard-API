<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>N9WH Field Day Scoreboard</title>

  <script src="/lib/chart.umd.min.js"></script>
  
  <!-- Leaflet for map (local copy for offline use) -->
  <link rel="stylesheet" href="/lib/leaflet.css" />
  <script src="/lib/leaflet.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #141927;
      --bg-card: #1a2332;
      --text-primary: #e8edf4;
      --text-secondary: #8b95a8;
      --accent-cyan: #00d4ff;
      --accent-orange: #ff6b35;
      --accent-green: #00ff88;
      --border-color: rgba(0, 212, 255, 0.15);
      --glow: rgba(0, 212, 255, 0.3);
    }

    [data-theme="light"] {
      --bg-primary: #f5f7fa;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #1a2332;
      --text-secondary: #5a6a7f;
      --accent-cyan: #0088cc;
      --accent-orange: #ff6b35;
      --accent-green: #00aa66;
      --border-color: rgba(0, 136, 204, 0.2);
      --glow: rgba(0, 136, 204, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'IBM Plex Mono', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
      position: relative;
      width: 1920px;
      height: 1080px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* Fullscreen optimization */
    @media (min-width: 1920px) and (min-height: 1080px) {
      body {
        transform: scale(1);
      }
      #timelineContainer {
        height: 400px !important;
      }
    }
    
    /* Scale down for smaller displays */
    @media (max-width: 1919px), (max-height: 1079px) {
      body {
        transform-origin: top left;
        transform: scale(calc(100vw / 1920));
      }
      #timelineContainer {
        height: 245px !important;
      }
    }

    /* Animated grid background */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: 
        linear-gradient(var(--border-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: gridMove 20s linear infinite;
      opacity: 0.3;
      z-index: 0;
    }

    @keyframes gridMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    .container {
      position: relative;
      z-index: 1;
      width: 100vw;
      height: 100vh;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background: var(--bg-card);
      padding: 15px 25px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 0 20px var(--glow);
      transition: all 0.3s ease;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .callsign {
      font-family: 'Orbitron', sans-serif;
      font-size: 42px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 3px;
      text-shadow: 0 0 30px var(--glow);
    }

    .event-badge {
      background: var(--accent-orange);
      color: #fff;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .theme-toggle {
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 1px;
    }

    .theme-toggle:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 15px var(--glow);
      transform: translateY(-2px);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-green);
      animation: pulse 2s infinite;
      transition: background 0.3s ease;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Pages */
    .pages {
      position: relative;
      height: calc(100vh - 120px);
    }

    .page {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      opacity: 0;
      transform: translateX(100px);
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }

    .page.active {
      opacity: 1;
      transform: translateX(0);
      pointer-events: all;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
      opacity: 0.6;
    }

    .card-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-cyan);
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* Page 1: Main Scoreboard */
    .page-1 {
      display: grid;
      grid-template-columns: 420px 420px 1fr;
      gap: 20px;
      height: 100%;
    }

    .col {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 20px;
    }

    .big-stat {
      text-align: center;
      padding: 30px;
    }

    .big-number {
      font-family: 'Orbitron', sans-serif;
      font-size: 72px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
      margin: 10px 0;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .mascot-card {
      background: linear-gradient(135deg, var(--accent-orange), #ff8c42);
      color: white;
      padding: 25px;
      height: 200px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mascot-text h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 32px;
      font-weight: 900;
      line-height: 1.2;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .mascot-text .credit {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 5px;
    }

    /* Page 2: Band Stats & Multipliers */
    .page-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto 1fr 1fr;
      gap: 20px;
      height: 100%;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
    }

    .stat-box:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px var(--glow);
    }

    .stat-box.goal-met {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(0, 255, 136, 0.1) 100%);
      border-color: var(--accent-green);
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
    }

    .stat-box.goal-met::before {
      content: '‚≠ê';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 32px;
      animation: star-pulse 2s ease-in-out infinite;
    }

    @keyframes star-pulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.2) rotate(15deg); }
    }

    .stat-box-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .stat-box-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 32px;
      font-weight: 900;
      color: var(--accent-cyan);
    }

    /* Page 3: Active Stations */
    .page-3 {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 20px;
      height: 100%;
    }

    .stations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 20px;
      overflow-y: auto;
      padding: 10px;
    }

    .station-card {
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .station-card:hover {
      border-color: var(--accent-green);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px var(--glow);
    }

    .station-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .station-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 22px;
      font-weight: 900;
      color: var(--accent-cyan);
      text-transform: uppercase;
    }

    .station-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .station-current {
      background: var(--bg-primary);
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid var(--accent-green);
    }

    .station-current-label {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }

    .station-current-info {
      display: flex;
      gap: 15px;
      font-size: 13px;
    }

    .station-current-item {
      display: flex;
      flex-direction: column;
    }

    .station-current-item-label {
      font-size: 10px;
      color: var(--text-secondary);
    }

    .station-current-item-value {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      color: var(--text-primary);
      margin-top: 2px;
    }

    .station-recent {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .station-recent-title {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .station-qso {
      background: var(--bg-primary);
      padding: 8px 10px;
      border-radius: 6px;
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
      font-size: 12px;
    }

    .station-qso-call {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      color: var(--accent-cyan);
    }

    .station-qso-info {
      color: var(--text-secondary);
      font-size: 11px;
    }

    .station-qso-time {
      color: var(--text-secondary);
      font-size: 10px;
    }

    /* Page 4: 3D Globe */
    .page-4 {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 20px;
      height: 100%;
    }

    #mapContainer {
      border-radius: 12px;
      overflow: hidden;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      position: relative;
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Chart styling */
    .chart-container {
      position: relative;
      height: 100%;
      min-height: 250px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* Page indicator */
    .page-indicator {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 1000;
    }

    .page-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .page-dot.active {
      background: var(--accent-cyan);
      box-shadow: 0 0 15px var(--glow);
      transform: scale(1.3);
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent-cyan);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-green);
    }

    /* Fire effect for high rates */
    @keyframes fire-pulse {
      0%, 100% { 
        text-shadow: 0 0 10px #ff6b35, 0 0 20px #ff6b35, 0 0 30px #ff6b35;
        transform: scale(1);
      }
      50% { 
        text-shadow: 0 0 20px #ff6b35, 0 0 30px #ff6b35, 0 0 40px #ff6b35, 0 0 50px #ff0000;
        transform: scale(1.05);
      }
    }

    .on-fire {
      animation: fire-pulse 1.5s ease-in-out infinite !important;
      color: #ff6b35 !important;
      font-weight: 900 !important;
    }

    /* Milestone celebration overlay */
    .milestone-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeInOut 3s ease-in-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }

    @keyframes celebration-bounce {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.2) rotate(-5deg); }
      50% { transform: scale(1.3) rotate(5deg); }
      75% { transform: scale(1.2) rotate(-5deg); }
    }

    .milestone-content {
      text-align: center;
      animation: celebration-bounce 0.6s ease-in-out 3;
    }

    .milestone-number {
      font-family: 'Orbitron', sans-serif;
      font-size: 120px;
      font-weight: 900;
      color: #00ff88;
      text-shadow: 0 0 20px #00ff88, 0 0 40px #00ff88, 0 0 60px #00ff88;
      margin: 0;
    }

    .milestone-text {
      font-family: 'Orbitron', sans-serif;
      font-size: 36px;
      color: #00d4ff;
      text-shadow: 0 0 10px #00d4ff;
      margin-top: 20px;
    }

    .milestone-emoji {
      font-size: 80px;
      margin-top: 20px;
    }
  </style>
</head>

<body data-theme="dark">
<div class="container">
  <div class="header">
    <div class="logo">
      <div class="callsign" id="headerCallsign">N9WH</div>
      <div class="event-badge" id="headerEvent">Winter Field Day 2026</div>
    </div>
    <div style="text-align: center; flex-grow: 1;">
      <div id="headerClubName" style="font-size: 14px; color: var(--text-secondary); font-weight: 600; margin-bottom: 4px;">McHenry County Amateur Radio Club</div>
      <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
        <div id="headerDateTime" style="font-size: 18px; color: var(--accent-cyan); font-family: 'IBM Plex Mono', monospace; font-weight: 600;"></div>
        <div id="weatherDisplay" style="font-size: 16px; color: var(--accent-green); font-weight: 600; display: none;">
          <span id="weatherIcon" style="font-size: 24px;">üå§Ô∏è</span>
          <span id="weatherTemp">--¬∞F</span>
        </div>
      </div>
    </div>
    <div class="controls">
      <button class="theme-toggle" onclick="toggleAutoRotate()" style="margin-right: 10px;">
        <span id="pauseIcon">‚è∏Ô∏è Pause</span>
      </button>
      <button class="theme-toggle" onclick="prevPage()" style="margin-right: 5px;">
        <span>‚Üê Prev</span>
      </button>
      <button class="theme-toggle" onclick="nextPage()" style="margin-right: 10px;">
        <span>Next ‚Üí</span>
      </button>
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span id="statusText">LIVE</span>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">‚òÄÔ∏è Light</span>
      </button>
    </div>
  </div>

  <div class="pages">
    <!-- Page 1: Main Scoreboard -->
    <div class="page page-1 active" data-page="1">
      <div class="col">
        <div class="card big-stat">
          <div class="stat-label">Total Contacts</div>
          <div id="totalContacts" class="big-number">‚Äî</div>
          <div class="stat-label" style="margin-top: 10px;">
            QSO Points: <span id="totalPoints" style="color: var(--accent-green);">‚Äî</span> | 
            Bonus: <span id="bonusPoints" style="color: var(--accent-orange);">‚Äî</span>
          </div>
          <div class="stat-label" style="font-size: 24px; margin-top: 8px; color: var(--accent-cyan);">
            Final Score: <span id="finalScore" style="font-weight: 900;">‚Äî</span>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Contacts by Operator</div>
          <div class="chart-container">
            <canvas id="opChart"></canvas>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card mascot-card">
          <div class="mascot-text">
            <h1>Winter</h1>
            <h1>Field Day</h1>
            <h1>Live Stats!</h1>
            <div class="credit">by: KC9MNE</div>
          </div>
          <img src="/mascot.png" alt="Mascot" width="180" height="auto" style="filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));">
        </div>
        <div class="card">
          <div class="card-title">Points by Operator</div>
          <div class="chart-container">
            <canvas id="ptsChart"></canvas>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="card-title">Contacts by Mode</div>
          <div class="chart-container" style="height: 250px;">
            <canvas id="modeChart"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Top Countries</div>
          <div class="chart-container">
            <canvas id="countryChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Page 2: Band Stats & Performance -->
    <div class="page page-2" data-page="2">
      <div class="card full-width" style="grid-column: 1 / -1;">
        <div class="card-title">üì° Band Activity & Performance</div>
        <div id="bandStats" class="stats-grid"></div>
      </div>
      
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-title">üìà QSO Timeline - Hourly Rate Throughout Event</div>
        <div class="chart-container" id="timelineContainer">
          <canvas id="timelineChart"></canvas>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <div class="card-title">üéØ Multipliers</div>
            <div class="stat-box">
              <div class="stat-box-label">ARRL Sections</div>
              <div class="stat-box-value" id="sectionsCount">‚Äî</div>
            </div>
          </div>
          <div>
            <div class="card-title">üèÜ Best Hour</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
              <div><strong id="bestHour">‚Äî</strong></div>
              <div id="bestHourQSOs" style="color: var(--accent-cyan); font-size: 18px; font-weight: 700;">‚Äî</div>
            </div>
          </div>
          <div>
            <div class="card-title">üìä Average Rate</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
              <div id="avgRate" style="color: var(--accent-green); font-size: 24px; font-weight: 700;">‚Äî</div>
              <div style="font-size: 11px;">QSOs per hour (overall)</div>
            </div>
          </div>
          <div>
            <div class="card-title">‚è±Ô∏è Operating Time</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
              <div id="totalHours" style="color: var(--accent-orange); font-size: 24px; font-weight: 700;">‚Äî</div>
              <div style="font-size: 11px;">Hours active</div>
            </div>
          </div>
        </div>
        
        <!-- Live Rate Row -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
          <div>
            <div class="card-title">üî• Current Rate (Last 20 min)</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
              <div id="rate20min" style="color: var(--accent-cyan); font-size: 32px; font-weight: 700; transition: all 0.3s;">‚Äî</div>
              <div style="font-size: 11px;">QSOs per hour</div>
            </div>
          </div>
          <div>
            <div class="card-title">‚ö° Current Rate (Last 60 min)</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
              <div id="rate60min" style="color: var(--accent-green); font-size: 32px; font-weight: 700; transition: all 0.3s;">‚Äî</div>
              <div style="font-size: 11px;">QSOs per hour</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Page 3: Active Stations -->
    <div class="page page-3" data-page="3">
      <div class="card">
        <div class="card-title">üìª Operating Stations</div>
        <div style="color: var(--text-secondary); font-size: 12px; margin-top: -8px;">Physical locations with current operator and recent contacts</div>
      </div>
      <div id="activeStations" class="stations-grid"></div>
    </div>

    <!-- Page 4: World Map -->
    <div class="page page-4" data-page="4">
      <div class="card">
        <div class="card-title">üåç Worldwide Contacts Map</div>
        <div style="display: flex; gap: 30px; margin-top: 10px;">
          <div>
            <span style="color: var(--text-secondary); font-size: 12px;">Countries: </span>
            <span id="countryCount" style="color: var(--accent-cyan); font-weight: 700; font-size: 18px;">‚Äî</span>
          </div>
          <div>
            <span style="color: var(--text-secondary); font-size: 12px;">States: </span>
            <span id="stateCount" style="color: var(--accent-green); font-weight: 700; font-size: 18px;">‚Äî</span>
          </div>
        </div>
      </div>
      <div id="mapContainer" style="width: 100%; height: 820px; border-radius: 12px; overflow: hidden; margin-top: 20px;"></div>
    </div>
  </div>

  <div class="page-indicator">
    <div class="page-dot active" onclick="goToPage(1)"></div>
    <div class="page-dot" onclick="goToPage(2)"></div>
    <div class="page-dot" onclick="goToPage(3)"></div>
    <div class="page-dot" onclick="goToPage(4)"></div>
  </div>
</div>

<script>
// ===== Theme Management =====
function toggleTheme() {
  const body = document.body;
  const currentTheme = body.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  body.setAttribute('data-theme', newTheme);
  document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
  
  updateAllCharts();
  updateMapTheme();  // Update Leaflet map tiles
}

// ===== Page Navigation =====
let currentPage = 1;
let autoRotate = true;

function goToPage(pageNum) {
  currentPage = pageNum;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.page-dot').forEach(d => d.classList.remove('active'));
  
  document.querySelector(`.page[data-page="${pageNum}"]`).classList.add('active');
  document.querySelectorAll('.page-dot')[pageNum - 1].classList.add('active');
  
  if (pageNum === 4) initMap();
}

function nextPage() {
  if (!autoRotate) return;
  currentPage = currentPage >= 4 ? 1 : currentPage + 1;
  goToPage(currentPage);
}

function prevPage() {
  currentPage = currentPage <= 1 ? 4 : currentPage - 1;
  goToPage(currentPage);
}

function toggleAutoRotate() {
  autoRotate = !autoRotate;
  const icon = document.getElementById('pauseIcon');
  icon.textContent = autoRotate ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') prevPage();
  if (e.key === 'ArrowRight') {
    currentPage = currentPage >= 4 ? 1 : currentPage + 1;
    goToPage(currentPage);
  }
  if (e.key === ' ') {
    e.preventDefault();
    toggleAutoRotate();
  }
  if (e.key >= '1' && e.key <= '4') {
    goToPage(parseInt(e.key));
  }
});

setInterval(nextPage, 15000);

// ===== Chart Helpers =====
const STAR = "‚òÖ ";

function getThemeColors() {
  const style = getComputedStyle(document.documentElement);
  return {
    text: style.getPropertyValue('--text-primary').trim(),
    secondary: style.getPropertyValue('--text-secondary').trim(),
    grid: style.getPropertyValue('--border-color').trim(),
    cyan: style.getPropertyValue('--accent-cyan').trim(),
    orange: style.getPropertyValue('--accent-orange').trim(),
    green: style.getPropertyValue('--accent-green').trim(),
  };
}

function palette(n) {
  const colors = [];
  for (let i = 0; i < n; i++) {
    const hue = Math.round((360 / n) * i);
    colors.push(`hsl(${hue}, 65%, 55%)`);
  }
  return colors;
}

function markLeader(labels, values) {
  const out = labels.slice();
  if (!values || values.length === 0) return out;
  let maxI = 0;
  for (let i = 1; i < values.length; i++) {
    if ((values[i] ?? 0) > (values[maxI] ?? 0)) maxI = i;
  }
  out[maxI] = STAR + out[maxI];
  return out;
}

const valueLabelPlugin = {
  id: 'valueLabelPlugin',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    const dataset = chart.data.datasets[0];
    const meta = chart.getDatasetMeta(0);
    if (!meta || !meta.data) return;

    const colors = getThemeColors();
    ctx.save();
    ctx.font = '600 14px "IBM Plex Mono"';
    ctx.fillStyle = colors.text;
    
    // Check if horizontal or vertical bars
    const isHorizontal = chart.options.indexAxis === 'y';

    meta.data.forEach((bar, i) => {
      const v = dataset.data[i];
      if (v === null || v === undefined) return;
      
      if (isHorizontal) {
        // Horizontal bars - label to the right
        ctx.textBaseline = 'middle';
        const x = bar.x + 6;
        const y = bar.y;
        ctx.fillText(String(v), x, y);
      } else {
        // Vertical bars - label above bar
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        const x = bar.x;
        const y = bar.y - 8;  // 8px above bar
        ctx.fillText(String(v), x, y);
      }
    });

    ctx.restore();
  }
};

Chart.register(valueLabelPlugin);

function baseHBarOptions() {
  const colors = getThemeColors();
  return {
    indexAxis: 'y',
    responsive: false,  // DISABLE responsive mode completely
    maintainAspectRatio: false,
    animation: false,
    layout: {
      padding: 0
    },
    plugins: { 
      legend: { display: false },
      tooltip: {
        backgroundColor: colors.secondary,
        titleColor: colors.text,
        bodyColor: colors.text,
        borderColor: colors.cyan,
        borderWidth: 1
      }
    },
    scales: {
      x: { 
        beginAtZero: true,
        ticks: { 
          precision: 0,
          color: colors.secondary,
          font: { family: 'IBM Plex Mono' }
        },
        grid: { color: colors.grid }
      },
      y: {
        ticks: { 
          color: colors.text,
          font: { family: 'IBM Plex Mono', weight: '600' },
          autoSkip: false
        },
        grid: { display: false }
      }
    }
  };
}

function baseBarOptions() {
  const colors = getThemeColors();
  return {
    responsive: false,  // DISABLE responsive mode completely
    maintainAspectRatio: false,
    animation: false,
    layout: {
      padding: 0
    },
    plugins: { 
      legend: { display: false },
      tooltip: {
        backgroundColor: colors.secondary,
        titleColor: colors.text,
        bodyColor: colors.text,
        borderColor: colors.cyan,
        borderWidth: 1
      }
    },
    scales: {
      x: {
        ticks: { 
          color: colors.text,
          font: { family: 'IBM Plex Mono', weight: '600' },
          autoSkip: false
        },
        grid: { display: false }
      },
      y: { 
        beginAtZero: true,
        ticks: { 
          precision: 0,
          color: colors.secondary,
          font: { family: 'IBM Plex Mono' }
        },
        grid: { color: colors.grid }
      }
    }
  };
}

// Set explicit canvas dimensions for 1920x1080 display
// Accounting for header (80px) and padding
const availableHeight = 1080 - 120; // ~960px for content

document.getElementById('opChart').width = 400;
document.getElementById('opChart').height = 800;  // Taller for operator list
document.getElementById('ptsChart').width = 400;
document.getElementById('ptsChart').height = 800;  // Taller for points list
document.getElementById('modeChart').width = 1000;
document.getElementById('modeChart').height = 240;
document.getElementById('countryChart').width = 1000;
document.getElementById('countryChart').height = 600;  // More room for countries
// Set timeline chart dimensions based on container
const timelineContainer = document.getElementById('timelineContainer');
const timelineCanvas = document.getElementById('timelineChart');
timelineCanvas.width = timelineContainer.offsetWidth - 40;  // Leave padding
timelineCanvas.height = timelineContainer.offsetHeight - 60;  // Leave room for labels

const opChart = new Chart(document.getElementById('opChart'), {
  type: 'bar',
  data: { labels: [], datasets: [{ data: [], borderWidth: 0, borderRadius: 8 }] },
  options: baseHBarOptions()
});

const ptsChart = new Chart(document.getElementById('ptsChart'), {
  type: 'bar',
  data: { labels: [], datasets: [{ data: [], borderWidth: 0, borderRadius: 8 }] },
  options: baseHBarOptions()
});

const modeChart = new Chart(document.getElementById('modeChart'), {
  type: 'bar',
  data: { labels: [], datasets: [{ data: [], borderWidth: 0, borderRadius: 8 }] },
  options: baseBarOptions()
});

const countryChart = new Chart(document.getElementById('countryChart'), {
  type: 'bar',
  data: { labels: [], datasets: [{ data: [], borderWidth: 0, borderRadius: 8 }] },
  options: baseHBarOptions()
});

const timelineChart = new Chart(document.getElementById('timelineChart'), {
  type: 'line',
  data: { 
    labels: [], 
    datasets: [{ 
      label: 'QSOs per Hour',
      data: [], 
      borderWidth: 3,
      borderColor: '#00d4ff',
      backgroundColor: 'rgba(0, 212, 255, 0.1)',
      fill: true,
      tension: 0.4,
      pointRadius: 5,
      pointBackgroundColor: '#00ff88',
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    }] 
  },
  options: {
    responsive: false,
    maintainAspectRatio: false,
    animation: false,
    plugins: { 
      legend: { display: false },
      tooltip: {
        backgroundColor: getThemeColors().secondary,
        titleColor: getThemeColors().text,
        bodyColor: getThemeColors().text,
        borderColor: getThemeColors().cyan,
        borderWidth: 1,
        callbacks: {
          title: function(context) {
            return context[0].label;  // Show time label
          },
          label: function(context) {
            return context.parsed.y + ' QSOs';
          }
        }
      }
    },
    scales: {
      x: {
        title: {
          display: true,
          text: 'Time (Hour)',
          color: getThemeColors().text,
          font: { family: 'IBM Plex Mono', size: 13, weight: '600' }
        },
        ticks: { 
          color: getThemeColors().text, 
          font: { family: 'IBM Plex Mono', size: 11 },
          maxRotation: 45,
          minRotation: 45,
          autoSkip: true,
          maxTicksLimit: 20  // Show up to 20 hour labels
        },
        grid: { color: getThemeColors().grid, lineWidth: 0.5 }
      },
      y: { 
        title: {
          display: true,
          text: 'QSOs per Hour',
          color: getThemeColors().text,
          font: { family: 'IBM Plex Mono', size: 13, weight: '600' }
        },
        beginAtZero: true,
        ticks: { 
          precision: 0,
          color: getThemeColors().secondary,
          font: { family: 'IBM Plex Mono' }
        },
        grid: { color: getThemeColors().grid }
      }
    }
  }
});

function updateAllCharts() {
  [opChart, ptsChart, modeChart, countryChart].forEach(chart => {
    if (chart.config.type === 'bar' && chart.options.indexAxis === 'y') {
      chart.options = baseHBarOptions();
    } else if (chart.config.type === 'bar') {
      chart.options = baseBarOptions();
    }
    chart.update('none');
  });
  
  // Update timeline chart colors for theme
  const colors = getThemeColors();
  timelineChart.data.datasets[0].borderColor = colors.cyan;
  timelineChart.data.datasets[0].backgroundColor = `${colors.cyan}1A`;
  timelineChart.data.datasets[0].pointBackgroundColor = colors.green;
  timelineChart.options.scales.x.title.color = colors.text;
  timelineChart.options.scales.x.ticks.color = colors.text;
  timelineChart.options.scales.x.grid.color = colors.grid;
  timelineChart.options.scales.y.title.color = colors.text;
  timelineChart.options.scales.y.ticks.color = colors.secondary;
  timelineChart.options.scales.y.grid.color = colors.grid;
  timelineChart.update('none');
}

// ===== Leaflet World Map =====
let map = null;
let mapMarkers = [];
let homeMarker = null;
let contactLines = [];

// Approximate country/state coordinates (lat, lon)
const locationCoords = {
  // Major countries
  'USA': [39, -98],
  'CANADA': [56, -106],
  'MEXICO': [23, -102],
  'UK': [54, -2],
  'UNITED KINGDOM': [54, -2],
  'GERMANY': [51, 10],
  'FRANCE': [46, 2],
  'ITALY': [42, 12],
  'SPAIN': [40, -4],
  'RUSSIA': [60, 100],
  'CHINA': [35, 105],
  'JAPAN': [36, 138],
  'AUSTRALIA': [-25, 133],
  'BRAZIL': [-10, -55],
  'ARGENTINA': [-34, -64],
  'SOUTH AFRICA': [-29, 24],
  'INDIA': [20, 77],
  'POLAND': [52, 20],
  'NETHERLANDS': [52, 5],
  'BELGIUM': [51, 4],
  'SWEDEN': [62, 15],
  'NORWAY': [62, 10],
  'FINLAND': [64, 26],
  'DENMARK': [56, 10],
  'CZECH REPUBLIC': [50, 15],
  'AUSTRIA': [47, 13],
  'SWITZERLAND': [47, 8],
  'PORTUGAL': [39, -8],
  'GREECE': [39, 22],
  'TURKEY': [39, 35],
  'UKRAINE': [49, 32],
  'ROMANIA': [46, 25],
  'NEW ZEALAND': [-41, 174],
  'SOUTH KOREA': [37, 127],
  'THAILAND': [15, 100],
  'INDONESIA': [-2, 118],
  'PHILIPPINES': [13, 122],
  'MALAYSIA': [4, 102],
  'SINGAPORE': [1, 104],
  'CHILE': [-30, -71],
  'PERU': [-10, -76],
  'COLOMBIA': [4, -72],
  'VENEZUELA': [8, -66],
  
  // US States (approximate centers)
  'IL': [40, -89], 'CA': [37, -120], 'TX': [31, -99], 'FL': [28, -82],
  'NY': [43, -75], 'PA': [41, -77], 'OH': [40, -82], 'MI': [44, -85],
  'WI': [44, -90], 'MN': [46, -94], 'IA': [42, -93], 'MO': [38, -92],
  'IN': [40, -86], 'KY': [38, -85], 'TN': [36, -86], 'AL': [33, -87],
  'MS': [33, -90], 'AR': [35, -92], 'LA': [31, -92], 'OK': [36, -97],
  'KS': [38, -98], 'NE': [41, -100], 'SD': [44, -100], 'ND': [47, -100],
  'MT': [47, -110], 'WY': [43, -108], 'CO': [39, -105], 'NM': [34, -106],
  'AZ': [34, -111], 'UT': [39, -111], 'NV': [39, -117], 'ID': [44, -114],
  'WA': [47, -121], 'OR': [44, -121], 'AK': [64, -150], 'HI': [21, -158],
  'ME': [45, -69], 'NH': [44, -71], 'VT': [44, -73], 'MA': [42, -72],
  'RI': [42, -71], 'CT': [41, -73], 'NJ': [40, -75], 'DE': [39, -75],
  'MD': [39, -77], 'VA': [38, -79], 'WV': [39, -81], 'NC': [35, -80],
  'SC': [34, -81], 'GA': [33, -84]
};

function initMap() {
  if (map) return;  // Already initialized
  
  const theme = document.body.getAttribute('data-theme') || 'dark';
  
  // Create map centered on home location (McHenry, IL)
  map = L.map('mapContainer', {
    center: [41.3, -88.4],
    zoom: 3,
    zoomControl: false,
    attributionControl: false
  });
  
  // Use CartoDB dark/light tiles (work offline if cached)
  const tileUrl = theme === 'dark' 
    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
    : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
  
  L.tileLayer(tileUrl, {
    maxZoom: 19,
    subdomains: 'abcd'
  }).addTo(map);
  
  // Add home station marker (McHenry, IL)
  homeMarker = L.circleMarker([41.3, -88.4], {
    radius: 10,
    fillColor: '#ff6b35',
    color: '#fff',
    weight: 3,
    opacity: 1,
    fillOpacity: 0.9
  }).addTo(map);
  
  homeMarker.bindPopup('<b>N9WH Home Station</b><br>McHenry, IL');
}

function addMapMarker(location, isCountry) {
  if (!map) initMap();
  
  const coords = locationCoords[location.toUpperCase()];
  if (!coords) return;  // Skip unknown locations
  
  const [lat, lon] = coords;
  
  // Create marker
  const marker = L.circleMarker([lat, lon], {
    radius: 6,
    fillColor: isCountry ? '#00d4ff' : '#00ff88',
    color: '#fff',
    weight: 2,
    opacity: 1,
    fillOpacity: 0.8
  }).addTo(map);
  
  marker.bindPopup(`<b>${location}</b>`);
  
  // Draw line from home to contact
  const line = L.polyline([[41.3, -88.4], [lat, lon]], {
    color: isCountry ? '#00d4ff' : '#00ff88',
    weight: 2,
    opacity: 0.5
  }).addTo(map);
  
  mapMarkers.push(marker);
  contactLines.push(line);
}

function updateMapBounds() {
  if (!map || mapMarkers.length === 0) return;
  
  // Collect all marker positions plus home
  const allPoints = mapMarkers.map(m => m.getLatLng());
  allPoints.push(homeMarker.getLatLng());
  
  // Only auto-zoom if we have contacts
  if (mapMarkers.length > 0) {
    map.fitBounds(L.latLngBounds(allPoints), { padding: [50, 50] });
  }
}

function clearMapMarkers() {
  mapMarkers.forEach(m => map.removeLayer(m));
  contactLines.forEach(l => map.removeLayer(l));
  mapMarkers = [];
  contactLines = [];
}

function updateMapTheme() {
  if (!map) return;
  
  const theme = document.body.getAttribute('data-theme') || 'dark';
  const tileUrl = theme === 'dark' 
    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
    : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
  
  // Remove old tiles and add new ones
  map.eachLayer(layer => {
    if (layer instanceof L.TileLayer) {
      map.removeLayer(layer);
    }
  });
  
  L.tileLayer(tileUrl, {
    maxZoom: 19,
    subdomains: 'abcd'
  }).addTo(map);
}

// ===== Data Processing =====
function applySnapshot(s) {
  // Check for milestones!
  checkMilestones(s.totals.contacts);
  checkNewBand(s.contactsByBand || []);
  
  document.getElementById('totalContacts').textContent = s.totals.contacts;
  document.getElementById('totalPoints').textContent = s.totals.points;
  document.getElementById('bonusPoints').textContent = s.totals.bonusPoints || 0;
  document.getElementById('finalScore').textContent = s.totals.finalScore || s.totals.points;

  const opLabels = s.contactsByOperator.map(x => x.Operator);
  const opVals = s.contactsByOperator.map(x => x.Contacts);
  opChart.data.labels = markLeader(opLabels, opVals);
  opChart.data.datasets[0].data = opVals;
  opChart.data.datasets[0].backgroundColor = palette(opVals.length);
  opChart.update('none');

  const ptLabels = s.pointsByOperator.map(x => x.Operator);
  const ptVals = s.pointsByOperator.map(x => x.Points);
  ptsChart.data.labels = markLeader(ptLabels, ptVals);
  ptsChart.data.datasets[0].data = ptVals;
  ptsChart.data.datasets[0].backgroundColor = palette(ptVals.length);
  ptsChart.update('none');

  const modeMap = { PHONE:0, CW:0, DIGITAL:0 };
  s.contactsByMode.forEach(m => {
    const k = (m.Mode || '').toUpperCase();
    if (['SSB','USB','LSB','AM','FM'].includes(k)) modeMap.PHONE += m.Contacts;
    else if (k === 'CW') modeMap.CW += m.Contacts;
    else modeMap.DIGITAL += m.Contacts;
  });

  modeChart.data.labels = ['Phone','CW','Digital'];
  modeChart.data.datasets[0].data = [modeMap.PHONE, modeMap.CW, modeMap.DIGITAL];
  modeChart.data.datasets[0].backgroundColor = [
    getThemeColors().orange,
    getThemeColors().cyan,
    getThemeColors().green
  ];
  modeChart.update('none');

  const countries = s.contactsByCountry.slice(0,15);
  countryChart.data.labels = countries.map(x => x.Country);
  countryChart.data.datasets[0].data = countries.map(x => x.Contacts);
  countryChart.data.datasets[0].backgroundColor = palette(countries.length);
  countryChart.update('none');

  const bands = s.contactsByBand || [];
  const bandGoals = clubConfig?.band_goals || {};
  const bandStatsHTML = bands.map(b => {
    const goal = bandGoals[b.Band] || 0;
    const metGoal = goal > 0 && b.Contacts >= goal;
    const goalClass = metGoal ? 'goal-met' : '';
    return `
    <div class="stat-box ${goalClass}" title="${goal > 0 ? 'Goal: ' + goal : 'No goal set'}">
      <div class="stat-box-label">${b.Band}${goal > 0 ? ' (Goal: ' + goal + ')' : ''}</div>
      <div class="stat-box-value">${b.Contacts}</div>
    </div>
  `}).join('');
  document.getElementById('bandStats').innerHTML = bandStatsHTML || '<div style="color: var(--text-secondary);">No band data available</div>';

  // Timeline chart - QSOs per hour throughout event
  const rateStats = s.rateStats || {};
  const hourlyData = rateStats.hourlyTotals || [];
  
  if (hourlyData.length > 0) {
    // Simplify labels to just show hour (e.g., "14:00", "15:00")
    timelineChart.data.labels = hourlyData.map(x => {
      const parts = x.hour.split('-');
      if (parts.length >= 4) {
        return `${parts[3]}:00`;  // Just the hour
      }
      return x.hour;
    });
    timelineChart.data.datasets[0].data = hourlyData.map(x => x.qsos);
  } else {
    console.warn('No hourly data available for timeline chart');
    timelineChart.data.labels = [];
    timelineChart.data.datasets[0].data = [];
  }
  timelineChart.update('none');

  // Performance stats
  const mults = s.multipliers || { sections: 0, sectionsList: [] };
  document.getElementById('sectionsCount').textContent = mults.sections;

  const bestHour = rateStats.bestHour;
  if (bestHour && bestHour.hour) {
    const parts = bestHour.hour.split('-');
    const hourLabel = parts.length >= 4 ? `${parts[1]}/${parts[2]} ${parts[3]}:00` : bestHour.hour;
    document.getElementById('bestHour').textContent = hourLabel;
    document.getElementById('bestHourQSOs').textContent = `${bestHour.qsos} QSOs`;
  } else {
    document.getElementById('bestHour').textContent = '‚Äî';
    document.getElementById('bestHourQSOs').textContent = '‚Äî';
  }

  // Calculate and display average rate
  const totalHours = rateStats.totalHours || 0;
  const avgRate = totalHours > 0 ? Math.round(s.totals.contacts / totalHours) : 0;
  document.getElementById('avgRate').textContent = avgRate;
  document.getElementById('totalHours').textContent = totalHours;

  // Display live rates with fire effect
  const rate20 = rateStats.rate20min || 0;
  const rate60 = rateStats.rate60min || 0;
  
  const rate20El = document.getElementById('rate20min');
  const rate60El = document.getElementById('rate60min');
  
  rate20El.textContent = rate20;
  rate60El.textContent = rate60;
  
  // Add fire effect if over 100 QSOs/hr
  if (rate20 >= 100) {
    rate20El.classList.add('on-fire');
  } else {
    rate20El.classList.remove('on-fire');
  }
  
  if (rate60 >= 100) {
    rate60El.classList.add('on-fire');
  } else {
    rate60El.classList.remove('on-fire');
  }

  // Page 3: Active Stations
  const stations = s.stations || [];
  const stationsHTML = stations.map(st => {
    const recentQSOs = (st.recent || []).map(qso => `
      <div class="station-qso">
        <div class="station-qso-call">${qso.call || '‚Äî'}</div>
        <div class="station-qso-info">${qso.operator || '‚Äî'} ‚Ä¢ ${qso.band || '‚Äî'} ${qso.mode || '‚Äî'}</div>
        <div class="station-qso-time">${qso.time || '‚Äî'}</div>
      </div>
    `).join('');

    return `
      <div class="station-card">
        <div class="station-header">
          <div class="station-name">${st.name || 'Unknown'}</div>
          <div class="station-status">
            <div class="status-dot" style="width: 8px; height: 8px;"></div>
            <span>ACTIVE</span>
          </div>
        </div>
        
        <div class="station-current">
          <div class="station-current-label">Current Operator</div>
          <div class="station-current-info">
            <div class="station-current-item">
              <div class="station-current-item-label">Operator</div>
              <div class="station-current-item-value">${st.operator || '‚Äî'}</div>
            </div>
            <div class="station-current-item">
              <div class="station-current-item-label">Band</div>
              <div class="station-current-item-value">${st.band || '‚Äî'}</div>
            </div>
            <div class="station-current-item">
              <div class="station-current-item-label">Mode</div>
              <div class="station-current-item-value">${st.mode || '‚Äî'}</div>
            </div>
          </div>
        </div>

        <div class="station-recent">
          <div class="station-recent-title">Recent Contacts</div>
          ${recentQSOs || '<div style="color: var(--text-secondary); font-size: 11px; padding: 10px;">No recent contacts</div>'}
        </div>
      </div>
    `;
  }).join('');
  
  document.getElementById('activeStations').innerHTML = stationsHTML || '<div class="card"><div style="color: var(--text-secondary); text-align: center; padding: 40px;">No active stations</div></div>';

  document.getElementById('countryCount').textContent = s.contactsByCountry.length;
  document.getElementById('stateCount').textContent = s.contactsByState.length;
  
  // Update Leaflet map with all contacts
  if (!map) initMap();
  
  clearMapMarkers();  // Clear old markers
  
  // Add markers for countries
  s.contactsByCountry.forEach(c => {
    addMapMarker(c.Country, true);  // true = is country
  });
  
  // Add markers for states  
  s.contactsByState.forEach(st => {
    addMapMarker(st.State, false);  // false = is state
  });
  
  // Update map bounds after all markers added
  updateMapBounds();
}

// ===== Milestone Celebrations =====
let lastContactCount = 0;
let achievedMilestones = new Set();
let bandFirstContacts = new Set();

function checkMilestones(currentCount) {
  // Contact milestones: 100, 500, 1000, 1500, 2000, etc.
  const milestones = [100, 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000];
  
  for (const milestone of milestones) {
    if (currentCount >= milestone && !achievedMilestones.has(milestone)) {
      achievedMilestones.add(milestone);
      showMilestoneAnimation(milestone, 'QSO MILESTONE!', 'üéâüéäüéâ');
      break; // Only show one at a time
    }
  }
  
  lastContactCount = currentCount;
}

function checkNewBand(bands) {
  // Check for first contact on each band
  bands.forEach(b => {
    const band = b.Band;
    if (b.Contacts === 1 && !bandFirstContacts.has(band)) {
      bandFirstContacts.add(band);
      showMilestoneAnimation(band, 'NEW BAND!', 'üì°üéØüì°');
    }
  });
}

function showMilestoneAnimation(value, text, emoji) {
  // Create overlay
  const overlay = document.createElement('div');
  overlay.className = 'milestone-overlay';
  
  const content = document.createElement('div');
  content.className = 'milestone-content';
  content.innerHTML = `
    <div class="milestone-number">${value}</div>
    <div class="milestone-text">${text}</div>
    <div class="milestone-emoji">${emoji}</div>
  `;
  
  overlay.appendChild(content);
  document.body.appendChild(overlay);
  
  // Play sound effect (if you add one later)
  // playSound('celebration');
  
  // Remove after animation completes
  setTimeout(() => {
    overlay.remove();
  }, 3000);
}

// ===== Config & Clock =====
let clubConfig = null;

async function loadConfig() {
  try {
    const r = await fetch("/api/config");
    if (r.ok) {
      clubConfig = await r.json();
      document.getElementById('headerCallsign').textContent = clubConfig.callsign;
      document.getElementById('headerEvent').textContent = clubConfig.event_name;
      document.getElementById('headerClubName').textContent = clubConfig.club_name;
      
      // Update home marker if map exists
      if (map && homeMarker) {
        homeMarker.setLatLng([clubConfig.home_lat, clubConfig.home_lon]);
        homeMarker.bindPopup(`<b>${clubConfig.callsign} Home Station</b><br>${clubConfig.home_location}`);
      }
      
      // Fetch weather if enabled
      if (clubConfig.weather_enabled) {
        fetchWeather();
      }
    }
  } catch (e) {
    console.warn("Config load failed:", e);
  }
}

async function fetchWeather() {
  try {
    // Use lat/lon from config for accurate location
    const lat = clubConfig.home_lat;
    const lon = clubConfig.home_lon;
    
    // Using wttr.in with coordinates - more accurate than zip!
    const r = await fetch(`https://wttr.in/${lat},${lon}?format=j1`);
    if (r.ok) {
      const data = await r.json();
      const current = data.current_condition[0];
      const temp = Math.round(current.temp_F);
      const weatherCode = parseInt(current.weatherCode);
      
      // Map weather codes to emojis
      const weatherIcons = {
        113: '‚òÄÔ∏è', 116: '‚õÖ', 119: '‚òÅÔ∏è', 122: '‚òÅÔ∏è', 143: 'üå´Ô∏è',
        176: 'üå¶Ô∏è', 179: 'üå®Ô∏è', 182: 'üå®Ô∏è', 185: 'üå®Ô∏è', 200: '‚õàÔ∏è',
        227: 'üå®Ô∏è', 230: 'üå®Ô∏è', 248: 'üå´Ô∏è', 260: 'üå´Ô∏è', 263: 'üå¶Ô∏è',
        266: 'üå¶Ô∏è', 281: 'üå®Ô∏è', 284: 'üå®Ô∏è', 293: 'üåßÔ∏è', 296: 'üåßÔ∏è',
        299: 'üåßÔ∏è', 302: 'üåßÔ∏è', 305: 'üåßÔ∏è', 308: 'üåßÔ∏è', 311: 'üå®Ô∏è',
        314: 'üå®Ô∏è', 317: 'üå®Ô∏è', 320: 'üå®Ô∏è', 323: 'üå®Ô∏è', 326: 'üå®Ô∏è',
        329: 'üå®Ô∏è', 332: 'üå®Ô∏è', 335: 'üå®Ô∏è', 338: 'üå®Ô∏è', 350: 'üå®Ô∏è',
        353: 'üå¶Ô∏è', 356: 'üåßÔ∏è', 359: 'üåßÔ∏è', 362: 'üå®Ô∏è', 365: 'üå®Ô∏è',
        368: 'üå®Ô∏è', 371: 'üå®Ô∏è', 374: 'üå®Ô∏è', 377: 'üå®Ô∏è', 386: '‚õàÔ∏è',
        389: '‚õàÔ∏è', 392: '‚õàÔ∏è', 395: 'üå®Ô∏è'
      };
      
      const icon = weatherIcons[weatherCode] || 'üå§Ô∏è';
      document.getElementById('weatherIcon').textContent = icon;
      document.getElementById('weatherTemp').textContent = `${temp}¬∞F`;
      document.getElementById('weatherDisplay').style.display = 'flex';
      document.getElementById('weatherDisplay').style.gap = '8px';
      document.getElementById('weatherDisplay').style.alignItems = 'center';
    }
  } catch (e) {
    console.warn("Weather fetch failed (no internet?):", e);
  }
}

function updateClock() {
  const now = new Date();
  const options = { 
    weekday: 'short', 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  };
  document.getElementById('headerDateTime').textContent = now.toLocaleString('en-US', options);
}

async function refresh() {
  const statusEl = document.getElementById('statusText');
  try {
    const r = await fetch("/api/snapshot", { cache: "no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const s = await r.json();
    applySnapshot(s);
    statusEl.textContent = "LIVE";
    document.querySelector('.status-dot').style.background = getThemeColors().green;
  } catch (e) {
    statusEl.textContent = "OFFLINE";
    document.querySelector('.status-dot').style.background = getThemeColors().orange;
    console.warn("snapshot fetch failed:", e);
  }
}

// Initialize
loadConfig();
updateClock();
setInterval(updateClock, 1000);  // Update clock every second
refresh();
setInterval(refresh, 3000);
</script>
</body>
</html>
